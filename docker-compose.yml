version: '3.8'

services:
  # 1. DATABASE
  qdrant:
    image: qdrant/qdrant:latest
    container_name: decay_memory_db
    volumes:
      - qdrant_storage:/qdrant/storage
    expose:
      - "6333"
    restart: unless-stopped

  # 2. BACKEND
  decay_memory_core:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: decay_memory_core
    expose:
      - "8080"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - OPENWEATHERMAP_API_KEY=${OPENWEATHERMAP_API_KEY}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - DECAY_API_SECRET=${DECAY_API_SECRET}
      - AUTH_ENABLED=${AUTH_ENABLED:-true}
    volumes:
      - ./flight_recorders:/app/flight_recorders
      - ./soul_state.json:/app/soul_state.json
      - ./heartbeat_mood.json:/app/heartbeat_mood.json
    depends_on:
      - qdrant
    restart: unless-stopped

  # 3. FRONTEND
  frontend:
    build:
      context: ./frontend
      args:
        - VITE_API_KEY=${DECAY_API_SECRET}
    container_name: decay_memory_ui
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - decay_memory_core
    restart: always

volumes:
  qdrant_storage:
